#!/usr/bin/env python
"""
Quick multi-purpose plotting.

Usage
-----
plot [options] <datafile>

Options
-------
-t <dtype>     NumpPy dtype string
-c <clim>      Set upper color scale limit to constant value.
-p <exponent>  Eponent power applied to data
"""
import os, sys, imp, getopt
import numpy as np
import matplotlib.pyplot as plt

def stats(f, msg=''):
    """
    Display statistic of a NumPy array f with optional message.
    """
    i = ~np.isnan(f)
    rmin = f[i].min().copy()
    rmax = f[i].max().copy()
    rmean = f[i].astype('d').mean()
    print('%12g %12g %12g  %s  %s' % (rmin, rmax, rmean, f.shape, msg))
    return

def plot(*argv):
    """
    Quick multi-purpose plotting.
    """
    # options
    opts, files = getopt.getopt(argv, 'c:t:p:')
    opts = dict(opts)
    clim = None
    power = None
    if '-c' in opts:
        clim = float(opts['-c'])
        clim = -clim, clim
    if '-p' in opts:
        power = float(opts['-p'])

    # init
    fig = plt.figure(figsize=(12, 7.2))
    print('         Min          Max         Mean  Shape')

    # loop over files
    for file in files:

        # test for file
        if not os.path.exists(file):
            sys.exit('No such file: %s' % file)

        # options
        title = os.path.splitext(os.path.split(file)[-1])[0]
        delta = None
        dtype = 'f'
        if '-t' in opts:
            dtype = opts['-t'].replace('l', '<').replace('b', '>')

        # read text file
        if file.lower().endswith('.txt'):
            data = np.loadtxt(file).T

        # read SAC file
        elif file.lower().endswith('.sac'):
            import obspy.core
            data = obspy.core.read(file)[0]
            delta = data.stats.delta,
            data = data.data

        # read NumPy file with metadata (if present)
        elif file.lower().endswith('.npy'):
            f = os.path.split(file)
            for i in range(1, len(f)):
                path = os.sep.join(f[:-i])
                tail = os.sep.join(f[i:])
                meta = os.path.join(path, 'meta.py')
                if os.path.exists(meta):
                    meta = imp.load_source('meta', meta)
                    try:
                        delta = meta.deltas[tail]
                        break
                    except:
                        pass
            data = np.load(file, mmap_mode='c')

        # read binary file with metadata (if present)
        else:
            shape = None
            f = os.path.split(file)
            for i in range(1, len(f)):
                path = os.sep.join(f[:-i])
                tail = os.sep.join(f[i:])
                meta = os.path.join(path, 'meta.py')
                if os.path.exists(meta):
                    meta = imp.load_source('meta', meta)
                    try:
                        dtype = meta.dtype
                        shape = meta.shapes[tail]
                        delta = meta.deltas[tail]
                        break
                    except:
                        pass
            if shape:
                data = np.memmap(file, dtype, 'r', 0, shape, 'F')
            else:
                data = np.memmap(file, dtype, 'r')

        # metadata
        shape = data.shape
        if delta == None:
            delta = len(shape) * [1]

        # setup figure
        fig.clf()
        ax = fig.add_subplot(111)
        ax.set_title(title)

        # plot
        if len(shape) == 1:
            stats(data, title)
            if power:
                data = data ** power
            x = np.arange(data.size) * delta[0]
            ax.plot(x, data)
        elif len(shape) == 2 and shape[0] == 2:
            stats(data[0], title)
            stats(data[1], title)
            if power:
                data = data[0], data[1] ** power
            ax.plot(data[0], data[1])
        elif len(shape) == 2:
            stats(data, title)
            if power:
                data = data ** power
            im = ax.imshow(data.T, origin='lower', interpolation='nearest')
            plt.colorbar(im, orientation='horizontal')
            if clim:
                im.set_clim(*clim)
        elif len(shape) == 3:
            for it in range(shape[2]):
                if file.lower().endswith('.npy'):
                    data = np.load(file, mmap_mode='c')[:,:,it]
                else:
                    data = np.memmap(file, dtype, 'r', 0, shape, 'F')[:,:,it]
                stats(data, '%s %s' % (title, it * delta[2]))
                ax.set_title('%s %s' % (title, it * delta[2]))
                if power:
                    data = data ** power
                if it == 0:
                    im = ax.imshow(data.T, origin='lower', interpolation='nearest')
                    fig.colorbar(im, orientation='horizontal')
                else:
                    im.set_array(data.T)
                if clim:
                    im.set_clim(*clim)
                else:
                    im.autoscale()
                fig.canvas.draw()
                fig.ginput(1, 0, False)
        else:
            sys.exit('more than 3 dimensions not supported')
        fig.canvas.draw()
        fig.ginput(1, 0, False)

# continue if command line
if __name__ == '__main__':
    plot(*sys.argv[1:])

