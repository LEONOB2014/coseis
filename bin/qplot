#!/usr/bin/env python
"""
Quick multi-purpose plotting.

Usage
-----
plot [options] <datafile>

Options
-------
-t <dtype>     NumpPy dtype string
-c <clim>      Set upper color scale limit to constant value.
-p <exponent>  Eponent power applied to data
"""
import os, sys, imp, getopt
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as ani

def stats(f, msg=''):
    """
    Display statistic of a NumPy array f with optional message.
    """
    i = ~np.isnan(f)
    print(f[i].min(), f[i].max(), f[i].mean(), msg)
    return

def plot(*argv):
    """
    Quick multi-purpose plotting.
    """
    # options
    opts, files = getopt.getopt(argv, 'c:t:p:')
    opts = dict(opts)
    clim = None
    power = None
    if '-c' in opts:
        clim = float(opts['-c'])
        clim = -clim, clim
    if '-p' in opts:
        power = float(opts['-p'])

    # loop over files
    for file in files:

        # test for file
        if not os.path.exists(file):
            sys.exit('No such file: %s' % file)

        # options
        title = os.path.splitext(os.path.split(file)[-1])[0]
        delta = 1,
        dtype = 'f'
        if '-t' in opts:
            dtype = opts['-t'].replace('l', '<').replace('b', '>')

        # read text file
        if file.lower().endswith('.txt'):
            data = np.loadtxt(file).T
            shape = data.shape

        # read NumPy file
        elif file.lower().endswith('.npy'):
            data = np.load(file)
            shape = data.shape

        # read SAC file
        elif file.lower().endswith('.sac'):
            import obspy.core
            data = obspy.core.read(file)[0]
            delta = data.stats.delta,
            data = data.data
            shape = data.shape

        # read binary file with SORD metadata (if present)
        else:
            shape = 0,
            f = os.path.split(file)
            for i in range(1,len(f)):
                path = os.sep.join(f[:-i])
                tail = os.sep.join(f[i:])
                meta = os.path.join(path, 'meta.py')
                if os.path.exists(meta):
                    meta = imp.load_source('meta', meta)
                    try:
                        shape = meta.shapes[tail]
                        delta = meta.deltas[tail]
                        dtype = meta.dtype
                        break
                    except:
                        pass
            if len(shape) == 1:
                data = np.fromfile(file, dtype)
            elif len(shape) == 2:
                nn = shape[1], shape[0]
                n = shape[0] * shape[1]
                data = np.fromfile(file, dtype, n).reshape(nn).T

        # create figure
        fig = plt.figure(None, (12, 7.2))
        ax = fig.add_subplot(111)

        # XY plot or 2D image
        if len(shape) < 3:
            if power:
                data **= power
            if len(shape) == 1:
                stats(data, title)
                t = np.arange(data.size) * delta[0]
                ax.plot(t, data)
            elif len(shape) == 2 and shape[0] == 2:
                stats(data[0], title)
                stats(data[1], title)
                ax.plot(data[0], data[1])
            elif len(shape) == 2:
                stats(data, title)
                im = ax.imshow(data.T, origin='lower', interpolation='nearest')
                plt.colorbar(im, orientation='horizontal')
                if clim:
                    im.set_clim(*clim)
            ax.set_title(title)
            plt.show()

        # 3D series of images
        else:
            plt.ion()
            fig.show()
            f1 = open(file)
            n  = shape[0] * shape[1]
            nn = shape[1], shape[0]
            for it in range(shape[-1]):
                data = np.fromfile(f1, dtype, n).reshape(nn).T
                stats(data, '%s %s' % (title, it * delta[-1]))
                ax.set_title('%s %s' % (title, it * delta[-1]))
                if power:
                    data **= power
                if it == 0:
                    im = ax.imshow(data.T, origin='lower', interpolation='nearest')
                    fig.colorbar(im, orientation='horizontal')
                else:
                    im.set_array(data.T)
                if clim:
                    im.set_clim(*clim)
                else:
                    im.autoscale()
                fig.canvas.draw()
                fig.ginput(1, 0, False)
                         

# continue if command line
if __name__ == '__main__':
    plot(*sys.argv[1:])

