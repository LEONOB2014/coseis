#!/usr/bin/env python
"""
Print binary file statistics. Default data type is 4 byte floating point.
"""
import os, sys, imp
import numpy as np
from numpy.lib.npyio import format as npy

block = 64 * 1024 * 1024
arg_dtype = None
args = []
for a in sys.argv[1:]:
    if a[0] == '-':
        arg_dtype = a[1:].replace('l', '<').replace('b', '>')
    else:
        args += [a]

print('         Min          Max         Mean  Shape')
for filename in args:
    fh = open(filename, 'rb')
    if filename.endswith('npy'):
        npy.read_magic(fh)
        shape, fcont, dtype = npy.read_array_header_1_0(fh)
        n = np.prod(shape)
    else:
        if arg_dtype:
            dtype = arg_dtype
        else:
            meta = os.path.dirname(filename)
            meta = os.path.join(meta, 'meta.py')
            try:
                meta = imp.load_source('meta', meta)
                dtype = meta.dtype
            except:
                dtype = 'f'
        nb = np.dtype(dtype).itemsize
        n = os.path.getsize(filename)
        if n == 0 or n % nb != 0:
            continue
        n //= nb
        shape = [int(n)]
    rmin =  np.inf
    rmax = -np.inf
    rsum = 0.0
    i = 0
    while i < n:
        b = min(n - i, block)
        r = np.fromfile(fh, dtype=dtype, count=b)
        rmin = min(rmin, r.min())
        rmax = max(rmax, r.max())
        rsum += r.astype('d').sum()
        i += b
    rmean = rsum / n
    print('%12g %12g %12g  %s  %s' % (rmin, rmax, rmean, shape, filename))

