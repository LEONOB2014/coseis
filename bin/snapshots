#!/usr/bin/env python
"""
Snapshot plots

Usage
-----
snapshots [options] <datafile>

Options
-------
-c <clim>   Set upper color scale limit to constant value.
-s          Step through with mouse clicks.
"""
import os, sys, getopt
import numpy as np
import matplotlib.pyplot as plt
import cst

# arguments
opts, args = getopt.getopt(sys.argv[1:], 'sc:')
opts = dict(opts)
clim = None
if '-c' in opts:
    clim = float(opts['-c'])
    clim = -clim, clim
file = args[0]


print ('-s' in opts), opts

# metadata
f = os.path.split(file)
for i in range(1,len(f)):
    path = os.sep.join(f[:-i])
    tail = os.sep.join(f[i:])
    meta = os.path.join(path, 'meta.py')
    if os.path.exists(meta):
        break
meta = cst.util.load(meta)
shape = meta.shapes[tail]
delta = meta.deltas[tail]
dtype = meta.dtype

# open snapshot files
f1 = open(file)

# setup figure
fig = plt.figure()

# loop over time steps
for it in range( shape[-1] ):

    # read snapshot
    nn = shape[1], shape[0]
    n = shape[0] * shape[1]
    s = np.fromfile(f1, dtype, n).reshape(nn)

    # plot image
    fig.clf()
    ax = fig.add_subplot(111)
    ax.set_title('%s %s' % (file, it * delta[-1]))
    im = ax.imshow(s, interpolation='nearest')
    fig.colorbar(im)
    if clim:
        im.set_clim(*clim)

    # draw and wait for mouse click
    fig.canvas.draw()
    fig.canvas.Update()
    fig.show()
    if '-s' in opts:
        fig.ginput(1, 0, False)

