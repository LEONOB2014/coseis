#!/bin/bash -e
#------------------------------------------------------------------------------#

echo -e "\nSORD setup"

mpi=guess
debug=no
dryrun=no
matlab=no
deleteout=no
remote=no
while getopts spgnmrld opt; do
  case $opt in
    s) mpi=no ;;
    p) mpi=yes ;;
    g) debug=yes ;;
    n) dryrun=yes ;;
    m) matlab=yes ;;
    d) deleteout=yes ;;
    r) remote=yes ;;
    l) remote=no ;;
  esac
done
shift $(( OPTIND - 1 ))
[ -n "$1" ] && echo "$1" > infile
infile=$( cat infile )

# run on remote host
if [ $remote = yes ]; then
  host="gach.ucsd.edu"
  host="phim.ucsd.edu"
  echo "running on remote host $host"
  ssh-add -L > /dev/null || ssh-add
  version=$( ./tarball )
  scp sord.tgz $host:
  ssh -x $host "tar zxf sord.tgz && cd sord-$version && ./sord $@ -l"
  exit
fi

#------------------------------------------------------------------------------#
# REad input

nn3=( 1 1 1 )
np3=( 1 1 1 )
for file in "in/defaults" "$infile"; do
if [ ! -f "$file" ]; then
  echo "file not found: $file"
  exit
fi
while read key params; do
  set -- $params
  case "$key" in
    switch) swtich=$2 ;;
    case)   case=$2 ;;
  esac
  if [ "$switch" = "$case" ]; then
    case "$key" in
      n)   nn3=( $1 $2 $3 ); nt=$4 ;;
      np)  np3=( $1 $2 $3 ) ;;
    esac
  fi
done < "$file"
done
nn=$(( nn3[0] * nn3[1] * nn3[2] ));
np=$(( np3[0] * np3[1] * np3[2] ));
[ $matlab = yes ] && np=1

#------------------------------------------------------------------------------#
# Metadata

[ $deleteout == yes ] && rm -rf out
[ -e out ] || mkdir out
rm -f batchjob

osname=$( uname )

if   [ "${HOSTNAME:0:2}" = ds ]; then machine="datastar"
elif [ "${HOSTNAME:0:2}" = tg ]; then machine="teragrid"
elif [ "$HOSTNAME" = master ];   then machine="babieca"
else machine=$HOSTNAME
fi

perl -e 'print pack('V',1) eq pack('L',1) ? "little\n":"big\n"' > out/endian

./tarball
cp sord.tgz out/
cp "$infile" out/in

floatsize=4
nvars=21
ram=$(( nn / np * floatsize * nvars / 1024 / 1024 ))

rate=250000
[ $matlab = yes ] && rate=70000
wt=$(( nt * nn / np / rate + 1 ))
hh=$(( wt / 3600 ))
mm=$(( wt % 3600 / 60 ))
ss=$(( wt % 60 ))
[ $hh -ge 1 ] && ss=0
wt=$( echo $hh $mm $ss | awk '{ printf "%d:%02d:%02d\n", $1, $2, $3 }' )

echo "RAM usage: at least ${ram}Mb"
echo "Run time: at least $wt"

cat << END > out/meta
login:   $LOGNAME
name:    $( finger $LOGNAME | sed -n 's/^.*e: //p' )
date:    $( date )
machine: $machine
host:    $HOSTNAME
os:      $( uname -a )
END

#------------------------------------------------------------------------------#
# Matlab backend

if [ $matlab = yes ]; then

cat << END > batchjob
#!/bin/bash -e
unset DISPLAY
nohup matlab -r "addpath m, sord, quit" > out.log &
END
chmod u+x batchjob

[ $dryrun = no ] && matlab -nodesktop -nosplash -r "addpath m; sord"

exit

fi

#------------------------------------------------------------------------------#
# Fortran backend

[ $mpi = guess -a $np -eq 1 ] && mpi=no
[ $mpi = guess -a $np -gt 1 ] && mpi=yes

OBJECT="\\
  globals.o \\
  zone.o \\
  dfcn.o \\
  dfnc.o \\
  hgcn.o \\
  hgnc.o \\
  snormals.o \\
  binio.o \\
  input.o \\
  setup.o \\
  arrays.o \\
  gridgen.o \\
  optimize.o \\
  matmodel.o \\
  pml.o \\
  fault.o \\
  momentsrc.o \\
  vstep.o \\
  wstep.o \\
  output.o"

OPTFLAGS=-O

if [ $mpi = no ]; then
  OBJECT="$OBJECT \\
  sord.o"
  FC=f95
  CC=cc
else
  OBJECT="$OBJECT \\
  psord.o \\
  mpisetup.o \\
  mpioutput.o"
  FC=mpif90
  CC=mpicc
fi

case $osname in
Linux)
  FC=gfortran
  OPTFLAGS=-O3
  ;;
SunOS)
  OPTFLAGS=-fast
  ;;
esac

[ $nn -lt 10000 ] && OPTFLAGS=-g

if [ $debug = yes ]; then
  OPTFLAGS=-g
fi

case $machine in
datastar)
  FC=mpxlf95_r
  CC=mpcc_r
  OPTFLAGS="-O3 -qstrict -qarch=pwr4 -qtune=pwr4 -q64"
  [ $debug = yes ] && OPTFLAGS="-g -qflttrap"
  ;;
babieca)
  [ $mpi = no ] && FC=pgf95
  ;;
esac

cat << END > tmp
FC = $FC
CC = $CC
FFLAGS = $OPTFLAGS
OBJECT = $OBJECT

fsord: \$(OBJECT) makefile
	\$(FC) -llapack \$(FFLAGS) \$(OBJECT) -o fsord

clean:
	rm -f *.o *.mod matlab_workspace.mat

realclean: clean
	rm -f fsord makefile batchjob sord.tgz infile

%.o: f/%.f95 makefile
	\$(FC) \$(FFLAGS) -c \$< -o \$@

END

[ ! -f makefile ] && touch makefile
[ "$( diff tmp makefile )" != "" ] && mv tmp makefile
rm -f tmp
[ $dryrun = no ] && gmake

#------------------------------------------------------------------------------#
# Machine specific batch submission and run commands

case $machine in

#--------------------------------------#
datastar)

cat << END
configuring for datastar
must be run from a subdirectory of /gpfs/
interactive (up to 32 procs, 64 GB, must be logged into dspoe)
batch submition (up to 1408 procs, 2816 GB):
  llsubmit batchjob
other useful commands:
  llcancel <jobID>
  llq
  llq -s <jovID>
  showq
  reslist
END
[ $( pwd | grep -v gpfs ) ] || exit

# batch
rate=100000
wt=$(( nt * nn / np / rate + 1 ))
hh=$(( wt / 3600 ))
mm=$(( wt % 3600 / 60 ))
ss=$(( wt % 60 ))
[ $hh -ge 1 ] && ss=0
wt=$( echo $hh $mm $ss | awk '{ printf "%d:%02d:%02d\n", $1, $2, $3 }' )
ppn=8;
[ $ppn -gt $np ] && ppn=$np
nodes=$(( np / ppn + ( np % ppn > 0 ? 1 : 0 ) ))
opts="-tasks_per_node $ppn -nodes $nodes -rmpool 1 -euilib us -euidevice sn_single"
rundir=$( /bin/pwd )
cat << END > batchjob
#!/bin/bash
#@ environment = COPY_ALL;\\
AIXTHREAD_COND_DEBUG=OFF;\\
AIXTHREAD_MUTEX_DEBUG=OFF;\\
AIXTHREAD_RWLOCK_DEBUG=OFF;\\
AIXTHREAD_SCOPE=S;\\
MP_ADAPTER_USE=dedicated;\\
MP_CPU_USE=unique;\\
MP_CSS_INTERRUPT=no;\\
MP_EAGER_LIMIT=65536;\\
MP_EUIDEVELOP=min;\\
MP_EUIDEVICE=sn_single;\\
MP_EUILIB=us;\\
MP_POLLING_INTERVAL=100000;\\
MP_PULSE=0;\\
MP_SHARED_MEMORY=yes;\\
MP_SINGLE_THREAD=no;\\
RT_GRQ=ON;\\
SPINLOOPTIME=0;\\
YIELDLOOPTIME=0;
#@ wall_clock_limit = $wt
#@ class = normal
#@ node_usage = not_shared
#@ notify_user = $LOGNAME
#@ node = $nodes
#@ tasks_per_node = $ppn
#@ job_type = parallel
#@ network.MPI = sn_single,not_shared,US,HIGH
#@ notification = always
#@ job_name = job.dfm
#@ output = out.log
#@ error = err.log
#@ initialdir = $rundir
#@ queue
cd $rundir
poe ./fsord $opts
END
chmod u+x batchjob

# interactive
[ $( hostname ) = ds100 ] || dryrun=yes
case $dryrun$debug$mpi in
  nonono)   ./fsord ;;
  nonoyes)  poe ./fsord $opts ;;
  noyesno)  totalview poe -a ./fsord $opts ;;
  noyesyes) totalview poe -a ./fsord $opts ;;
esac

;;

#--------------------------------------#
teragrid)

cat << END
configureing for Teragrid
batch submission:
qsub batchjob
END

# batch
rate=100000
wt=$(( nt * nn / np / rate + 1 ))
hh=$(( wt / 3600 ))
mm=$(( wt % 3600 / 60 ))
ss=$(( wt % 60 ))
[ $hh -ge 1 ] && ss=0
wt=$( echo $hh $mm $ss | awk '{ printf "%d:%02d:%02d\n", $1, $2, $3 }' )
ppn=2;
[ $ppn -gt $np ] && ppn=$np
nodes=$(( np / ppn + ( np % ppn > 0 ? 1 : 0 ) ))
cat << END > batchjob
#!/bin/bash
#PBS -q dque
#PBS -N sord_job
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -l walltime=$wt
#PBS -o out.log
#PBS -e err.log
#PBS -V
cd $rundir
time mpirun -v -machinefile \$PBS_NODEFILE -np $np ./fsord
END
chmod u+x batchjob

case $dryrun$debug$mpi in
  nonono)   ./fsord ;;
  noyesno)  gdb ./fsord ;;
  noyesyes) time mpirun -v -machinefile \$PBS_NODEFILE -np $np ./fsord ;;
esac

;;

#--------------------------------------#
babieca)

cat << END
configuring for babieca
batch submission (up to 19 procs):
qsub batchjob
other useful commands: pbsnodes -a, pingd, qstat, qdel
END

# batch
ppn=2
[ $ppn -gt $np ] && ppn=$np
nodes=$(( np / ppn + ( np % ppn > 0 ? 1 : 0 ) ))
cat << END > batchjob
#!/bin/bash
#PBS -q workq
#PBS -N sord_job
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -o out.log
#PBS -e err.log
#PBS -V
sleep 2
cd $rundir
time mpiexec -np $np ./fsord
END
chmod u+x batchjob

# interactive
case $dryrun$debug$mpi in
  nonono)   ./fsord ;;
  noyesno)  gdb ./fsord ;;
  nonoyes)  mpiexec -np $np ./fsord ;;
  noyesyes) mpiexec -np $np -dbg=gdb ./fsord ;;
esac

;;

#--------------------------------------#
*)

# batch
case $mpi in
  no)  cmd="" ;;
  yes) cmd="mpirun -np $np" ;;
esac
cat << END > batchjob
#!/bin/bash
nohup $cmd ./fsord > out.log &
END
chmod u+x batchjob

# interactive
case $dryrun$debug$mpi in
  nonono)   ./fsord ;;
  noyesno)  ddd ./fsord ;;
  nonoyes)  mpirun -np $np ./fsord ;;
  noyesyes) mpirun -np $np -dbg=ddd ./fsord ;;
esac

;;

esac

#------------------------------------------------------------------------------#
