#!/bin/bash -e

dir=$( /bin/pwd )
base=$( basename "$dir" )
version=$( date +%Y%m%d%H%M%S )

cat << END > versionmeta.m
version = '$version';
login   = '$LOGNAME';
name    = '$( finger $LOGNAME | sed -n 's/^Login.*:.*e: //p' )';
host    = '$HOSTNAME';
dir     = '$dir';
END

files="
  $base/versionmeta.m
  $base/doc
  $base/sord
  $base/in.m
  $base/in
  $base/sh
  $base/f
  $base/m
  $base/util
  $base/scecvm4
"
rm -f f/*.o f/*.mod f/*.ipo f/*.il f/*.stb
mkdir -p tmp
cd $( dirname "$dir" )
tar cf - $files | gzip > "$dir/tmp/$base.tgz"
cd "$dir"

[ "x$1" = "x-s" ] && cp "tmp/$base.tgz" "save/$base-$version.tgz"

exit 0

