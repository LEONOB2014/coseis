#!/bin/bash -e

if [ $( /bin/pwd | grep -v gpfs ) ]; then
  echo "Error: jobs must be run from /gpfs"
  exit
fi

if [ "$interactive" ]; then
cat << END > mf
tg-c127:2
tg-c128:2
tg-c129:2
tg-c130:2
END
if ! grep -q "$HOSTNAME" mf; then
  echo "Error: interactive jobs must be launched from the following hosts:"
  sed 's/^/  /; s/:2//' mf
  exit
fi
elif [ "$mode" = p ]; then
cat << END > pbsscript
#!/bin/bash
#PBS -N sord-$count
#PBS -l walltime=$walltime
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -q dque
#PBS -V
mail $email -s "Started on TeraGrid" < /dev/null
cd "$rundir"
echo "\$PBS_JOBID" >> log
echo "\$(date): Start SORD run" >> log
mpirun -machinefile \$PBS_NODEFILE -np $np ./sord-$mode
echo "\$(date): Finished" >> log
mail $email -s "Finished on TeraGrid" < /dev/null
END
chmod u+x pbsscript
if [ "$nc" ]; then
cat << END > pbsscript-vm
#!/bin/bash
#PBS -N sord-vm-$count
#PBS -l walltime=$walltime
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -q dque
#PBS -V
mail $email -s "Started on TeraGrid" < /dev/null
cd "$rundir"
echo "\$PBS_JOBID" >> log
echo "\$(date): Start VM run" >> log
cd "$rundir/vm"
mpirun -machinefile \$PBS_NODEFILE -np $np ./scecvm4-$mode $nc rlon rlat rdep rho vp vs
mv rho vp vs "$rundir/data"
cd "$rundir"
echo "\$(date): Start SORD run" >> log
mpirun -machinefile \$PBS_NODEFILE -np $np ./sord-$mode
echo "\$(date): Finished" >> log
mail $email -s "Finished on TeraGrid" < /dev/null
END
chmod u+x pbsscript-vm
fi
fi

case "$mode$run" in
  si) ./sord-s ;;
  sg) totalview ./sord-s ;;
  sb) nohup ./sord-s > out.log & :; pid=$! ;;
  pi) mpirun -machinefile mf -np $np ./sord-p ;;
  pg) mpirun -tv -machinefile mf -np $np ./sord-p ;;
  pb) nohup mpirun -machinefile mf -np $np ./sord-p > out.log & :; pid=$! ;;
  pq) pbsjob=$( qsub pbsscript ) ;;
esac

if [ "$pid" ]; then
  echo "$pid" >> log
  echo "Background job started, to cancel: out/$count/cancel.sh"
  echo "#!/bin/bash" > 'cancel.sh'
  echo "kill $pid" >> 'cancel.sh'
  chmod u+x 'cancel.sh'
fi
if [ "$pbsjob" ]; then
  echo "$pbsjob" >> log
  echo "PBS job submitted, to cancel: out/$count/cancel.sh"
  echo "#!/bin/bash" > 'cancel.sh'
  echo "qdel $pbsjob" >> 'cancel.sh'
  chmod u+x 'cancel.sh'
fi

