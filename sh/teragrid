#!/bin/bash -e
# SDSC TeraGrid IA64 cluster

cat << END > run
#!/bin/bash -e
mode=$mode
cd "$rundir"
if [ \$( /bin/pwd | grep -v gpfs ) ]; then
  echo "Error: jobs must be run from /gpfs"
  exit
fi
echo "\$( date ): $code started" >> log
$pre
case "\$mode\${1:--i}" in
  s-i)  time $bin ;;
  s-g)  gdb $bin ;;
  s-tv) totalview $bin ;;
  p-i)  mpirun -machinefile mf -np $np $bin ;;
  p-tv) mpirun -tv -machinefile mf -np $np $bin ;;
esac
$post
echo "\$( date ): $code finished" >> log
END

cat << END > mf
tg-c127:2
tg-c128:2
tg-c129:2
tg-c130:2
END

cat << END > que
#!/bin/bash
# qsub -W depend=afterok:$1
cd "$rundir"
if [ \$( /bin/pwd | grep -v gpfs ) ]; then
  echo "Error: jobs must be run from /gpfs"
  exit
fi
echo "\$( date ): $code qued with ID: \$( qsub script )" >> log
END

cat << END > script
#!/bin/bash
#PBS -N $code$count
#PBS -l walltime=$walltime
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -q dque
#PBS -M $email
#PBS -m abe
#PBS -V
cd "$rundir"
echo "\$( date ): $code started" >> log
$pre
mpirun -machinefile \$PBS_NODEFILE -np $np $bin
$post
echo "\$( date ): $code finished" >> log
END

chmod u+x run que script

