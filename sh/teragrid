#!/bin/bash -e

if [ $( /bin/pwd | grep -v gpfs ) ]; then
  echo "Error: jobs must be run from /gpfs"
  exit
fi

cat << END > run-$name
#!/bin/bash -e
if ! grep -q "\$HOSTNAME" mf; then
  echo "Error: interactive jobs must be launched from the following hosts:"
  sed 's/^/  /; s/:2//' mf
  exit
fi
cd "$rundir"
echo "\$( date ): Start $name" >> log
$pre
END

case "$mode" in

s) cat << END >> run-$name
case \${1:?} in
  -i) $bin ;;
  -g) totalview $bin ;;
  -b) nohup $bin > out.log & :; pid=\$!
      echo "Background job started with PID \$pid" >> log
      echo "Background job started with PID \$pid" ;;
esac
cd "$rundir"
echo "\$( date ): Finish $name" >> log
END
;;

p) cat << END >> run-$name
case \${1:?} in
  -i) mpirun -machinefile mf -np $np $bin ;;
  -g) mpirun -tv -machinefile mf -np $np $bin ;;
  -b) nohup mpirun -machinefile mf -np $np $bin > out.log & :; pid=\$!
      echo "Background job started with PID \$pid" >> log
      echo "Background job started with PID \$pid" ;;
esac
cd "$rundir"
echo "\$( date ): Finish $name" >> log
END
;;

esac

cat << END > mf
tg-c127:2
tg-c128:2
tg-c129:2
tg-c130:2
END

cat << END > que-$name
#!/bin/bash
echo "\$( date ): Job qued with ID: \$( qsub script-$name )" >> log
END

cat << END > script-$name
#!/bin/bash
#PBS -N $name-$count
#PBS -l walltime=$walltime
#PBS -l nodes=$nodes:ppn=$ppn
#PBS -q dque
#PBS -M $email
#PBS -m abe
#PBS -V
cd "$rundir"
echo "\$( date ): Start $name" >> log
$pre
mpirun -machinefile \$PBS_NODEFILE -np $np $bin
cd "$rundir"
echo "\$( date ): Finish $name" >> log
END

chmod u+x run-$name que-$name script-$name

