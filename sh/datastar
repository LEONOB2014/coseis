#!/bin/bash -e

if [ $( /bin/pwd | grep -v gpfs ) ]; then
  echo "Error: jobs must be run from /gpfs"
  exit
fi

cat << END > run-$name
#!/bin/bash -e
if [ "\$HOSTNAME" != ds100 ]; then
  echo "Error: interactive jobs must be launched from dspoe"
  exit
fi
log="$rundir/log"
echo "\$( date ): Start $name" >> "\$log"
$pre
END

case "$mode" in

s) cat << END >> run-$name
case "\${1:?}" in
  -i) $bin ;;
  -g) totalview $bin ;;
  -b) nohup $bin > out.log & :; pid=\$!
      echo "Background job started with PID \$pid" >> "\$log"
      echo "Background job started with PID \$pid" ;;
esac
$post
echo "\$( date ): Finish $name" >> "\$log"
END
;;

p) cat << END >> run-$name
opts="-tasks_per_node $ppn -nodes $nodes -rmpool 1 -euilib us -euidevice sn_all"
case "\${1:?}" in
  -i) poe $bin \$opts ;;
  -g) tvpoe $bin \$opts ;;
  -b) nohup poe $bin \$opts > out.log & :; pid=\$!
      echo "Background job started with PID \$pid" >> "\$log"
      echo "Background job started with PID \$pid" ;;
esac
$post
echo "\$( date ): Finish $name" >> "\$log"
END
;;

esac

cat << END > que-$name
#!/bin/bash
llsubmit script-$name >> log
END

cat << END > script-$name
#!/bin/bash
#@environment = COPY_ALL;\\
#AIXTHREAD_SCOPE=S;\\
#MP_ADAPTER_USE=dedicated;\\
#MP_CPU_USE=unique;\\
#MP_CSS_INTERRUPT=no;\\
#MP_EAGER_LIMIT=32768;\\
#MP_EUIDEVELOP=min;\\
#MP_LABELIO=yes;\\
#MP_POLLING_INTERVAL=100000;\\
#MP_PULSE=0;\\
#MP_SHARED_MEMORY=yes;\\
#MP_SINGLE_THREAD=no;\\
#RT_GRQ=ON;\\
#SPINLOOPTIME=0;\\
#YIELDLOOPTIME=0;
#@ job_name = $name-$count
#@ initialdir = $rundir
#@ node = $nodes
#@ tasks_per_node = $ppn
#@ wall_clock_limit = $walltime
#@ notification = always
#@ notify_user = $email
#@ job_type = parallel
#@ class = normal
#@ node_usage = not_shared
#@ network.MPI = sn_all, shared, US
#@ output = out.\$(jobid)
#@ error = err.\$(jobid) 
#@ queue
log="$rundir/log"
echo "\$( date ): Start $name" >> "\$log"
$pre
poe $bin
$post
echo "\$( date ): Finish $name" >> "\$log"
END

chmod u+x run-$name que-$name script-$name

