#!/bin/bash -e

cat << END > run
#!/bin/bash -e
mode=$mode
cd "$rundir"
echo "\$(date): $code started" >> log
[ "\$mode" = p ] && mpich2version &> /dev/null && ! mpdtrace &> /dev/null && mpd --daemon
$pre
case "\${1:--i}\$mode" in
  -is) $bin ;;
  -gs) ddd $bin ;;
  -ip) mpiexec -np $np $bin ;;
  -gp) mpiexec -gdb -np $np $bin ;;
  -dddp) mpiexec -np $np ddd $bin ;;
esac
$post
echo "\$(date): $code finished" >> log
END

cat << END > que
#!/bin/bash -e
cd "$rundir"
nice nohup ./run > out.log &
pid=\$!
echo "\$(date): PID: \$pid" >> log
echo "$code started with PID: \$pid"
END

chmod u+x run que

