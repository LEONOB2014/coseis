#!/bin/bash -e

cd "$( dirname $0 )"
srcdir=$( /bin/pwd )
cd ..

. sh/findfortran
flags=$oflags

files="
  $getarg
  asc2flt.f90
  swab.f90
  drape.f90
  utm.f90
  ll2utm.f90
  tscoords.f90
  tsgrid.f90
  ts2ll.f90
  ll2ts.f90
  pscoords.f90
  ps2ll.f90
  ll2ps.f90
  gearthdrape.f90"

mkdir -p tmp
cd tmp
for file in $files; do
  ln -s "$srcdir/$file" &> /dev/null || :
done
cat $files > state
echo "$sfc $flags" >> state

compile=yes
if [ -f state-util ]; then
  compile=$( cmp state state-util || : )
fi

if [ "$compile" ]; then
  echo "Compiling SORD utilities"
  rm -f state-util
  $sfc $flags $getarg asc2flt.f90 -o asc2flt
  $sfc $flags $getarg swab.f90 -o swab
  $sfc $flags drape.f90 -o drape
  $sfc $flags $getarg utm.f90 ll2utm.f90 -o ll2utm
  $sfc $flags utm.f90 tscoords.f90 tsgrid.f90 -o tsgrid
  $sfc $flags utm.f90 tscoords.f90 ts2ll.f90 -o ts2ll
  $sfc $flags utm.f90 tscoords.f90 ll2ts.f90 -o ll2ts
  $sfc $flags utm.f90 pscoords.f90 ps2ll.f90 -o ps2ll
  $sfc $flags utm.f90 pscoords.f90 ll2ps.f90 -o ll2ps
  $sfc $flags $getarg utm.f90 gearthdrape.f90 -o gearthdrape
  mv state state-util
  rm -f *.o *.mod *.ipo *.il *.stb
fi
rm -f $files

