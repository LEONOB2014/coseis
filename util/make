#!/bin/bash -e

IFS=":$IFS"
for dir in $PATH; do
for file in xlf95_r ifort pgf90 gfortran f95; do
  if [ -x $dir/$file ]; then
    sfc=$file
    break 2
  fi
done
done

getarg=''
pfc='mpif90'
case $sfc in
xlf95_r)
  sfc='xlf95_r -qsuffix=f=f90 -q64 -qsuppress=cmpmsg'
  pfc='mpxlf95_r -qsuffix=f=f90 -q64 -qsuppress=cmpmsg'
  gflags='-p -g -C -qflttrap -qsigtrap -qlanglvl=95pure'
  oflags='-O5'
  ;;
ifort)
  gflags='-O0 -p -g -CB -warn -traceback -u'
  oflags='-O3'
  ;;
pgf90)
  getarg='getarg-pgf.f90'
  gflags='-O0 -g -Ktrap=fp -Mbounds -Mdclchk -Mprof=lines'
  gflags='-O0 -g -Ktrap=fp -Mbounds'
  oflags='-fast'
  ;;
gfortran)
  gflags='-O0 -p -g -W -pedantic -std=legacy -fbounds-check'
  gflags='-O0 -g -W -fbounds-check -ffpe-trap=invalid,zero,overflow,underflow'
  oflags='-O3'
  ;;
f95)  gflags='-g'
  oflags='-O'
  if [ $( uname ) = SunOS ]; then
    gflags='-g -w4 -u -C'
    oflags='-fast'
  fi
  ;;
*)
  echo "Error: no Fortran 95 compiler found"
  exit
esac

cd ..
srcdir=$( /bin/pwd )
mkdir -p "$srcdir/tmp"
cd tmp
for file in "$srcdir/util/"*; do
  [ -e $( basename "$file" ) ] || ln -s "$file"
done
for file in "$srcdir/data/"*; do
  [ -e $( basename "$file" ) ] || ln -s "$file"
done
mkdir -p 01
mkdir -p 02
mkdir -p 03
mkdir -p 04
ln -sf '../x1'  '01/x1'
ln -sf '../x2'  '01/x2'
ln -sf '../x3'  '01/x3'
ln -sf '../rho' '02/rho1'
ln -sf '../vp'  '03/vp1'
ln -sf '../vs'  '04/vs1'
echo 1 > currentstep

flags=$oflags

$sfc $flags utm.f90 tscoords.f90 tsgrid.f90 -o tsgrid
$sfc $flags utm.f90 tscoords.f90 tsgridr.f90 -o tsgridr
$sfc $flags utm.f90 tscoords.f90 ts2ll.f90 -o ts2ll
$sfc $flags $getarg utm.f90 tscoords.f90 ll2ts.f90 -o ll2ts
$sfc $flags $getarg flt2asc.f90 -o flt2asc
$sfc $flags $getarg int2asc.f90 -o int2asc
$sfc $flags $getarg asc2flt.f90 -o asc2flt
$sfc $flags $getarg asc2int.f90 -o asc2int
$sfc $flags $getarg stats.f90 -o stats
$sfc $flags $getarg swab.f90 -o swab
$sfc $flags drape.f90 -o drape

tar zxf scecvm4.tgz
cp scecvm4.h 'in.h'

flags=$oflags
flags=$gflags
flags=

$sfc $flags iobin.f scecvm4.f -o scecvm4-s
#$pfc $flags iompi.f scecvm4.f -o scecvm4-p

rm -f *.mod

